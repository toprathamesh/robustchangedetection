{% extends 'core/base.html' %}

{% block title %}Interactive Map - Change Detection{% endblock %}

{% block extra_css %}
<style>
    .map-container {
        height: 70vh;
        width: 100%;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .control-panel {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
    }
    
    .leaflet-control-layers {
        background: white;
        border-radius: 8px;
    }
    
    .draw-controls {
        background: white;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        position: absolute;
        top: 20px;
        right: 20px;
        z-index: 1000;
        min-width: 200px;
    }
    
    .btn-draw {
        width: 100%;
        margin-bottom: 10px;
    }
    
    .aoi-info {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 4px;
        padding: 10px;
        margin-top: 10px;
        font-size: 0.9em;
    }
</style>
{% endblock %}

{% block breadcrumb %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'core:dashboard' %}">Dashboard</a></li>
        <li class="breadcrumb-item active">Interactive Map</li>
    </ol>
</nav>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2 class="h3 fw-bold mb-1">Interactive Map</h2>
                <p class="text-muted mb-0">Draw areas of interest and visualize change detection results</p>
            </div>
            <div>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#aoiModal">
                    <i class="fas fa-plus me-2"></i>Create New AOI
                </button>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <!-- Map -->
        <div class="card">
            <div class="card-body p-0">
                <div id="map" class="map-container"></div>
            </div>
        </div>
        
        <!-- Drawing Controls (Overlay) -->
        <div class="draw-controls">
            <h6 class="fw-bold mb-3">Drawing Tools</h6>
            <button id="drawPolygon" class="btn btn-outline-primary btn-draw">
                <i class="fas fa-draw-polygon me-2"></i>Draw AOI
            </button>
            <button id="editPolygon" class="btn btn-outline-warning btn-draw">
                <i class="fas fa-edit me-2"></i>Edit AOI
            </button>
            <button id="deletePolygon" class="btn btn-outline-danger btn-draw">
                <i class="fas fa-trash me-2"></i>Delete AOI
            </button>
            <button id="clearAll" class="btn btn-outline-secondary btn-draw">
                <i class="fas fa-eraser me-2"></i>Clear All
            </button>
            
            <div id="aoiInfo" class="aoi-info" style="display: none;">
                <strong>Selected AOI:</strong><br>
                <span id="aoiName">-</span><br>
                <strong>Area:</strong> <span id="aoiArea">-</span> km²
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <!-- AOI List -->
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-list me-2"></i>Your Areas of Interest
                </h5>
            </div>
            <div class="card-body">
                <div id="aoiList">
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-map-marker-alt fa-3x mb-3"></i>
                        <p>No AOIs created yet.<br>Use the map to draw your first area of interest.</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Map Layers -->
        <div class="card mt-3">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-layers-group me-2"></i>Map Layers
                </h5>
            </div>
            <div class="card-body">
                <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" id="satelliteLayer" checked>
                    <label class="form-check-label" for="satelliteLayer">
                        Satellite Imagery
                    </label>
                </div>
                <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" id="aoiLayer" checked>
                    <label class="form-check-label" for="aoiLayer">
                        Areas of Interest
                    </label>
                </div>
                <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" id="changeLayer">
                    <label class="form-check-label" for="changeLayer">
                        Change Detection Results
                    </label>
                </div>
            </div>
        </div>
        
        <!-- Recent Changes -->
        <div class="card mt-3">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-clock me-2"></i>Recent Changes
                </h5>
            </div>
            <div class="card-body">
                <div id="recentChanges">
                    <p class="text-muted">No recent changes detected.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- AOI Creation Modal -->
<div class="modal fade" id="aoiModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create Area of Interest</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="aoiForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="aoiNameInput" class="form-label">Name</label>
                        <input type="text" class="form-control" id="aoiNameInput" required>
                    </div>
                    <div class="mb-3">
                        <label for="aoiDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="aoiDescription" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="satelliteSource" class="form-label">Satellite Source</label>
                        <select class="form-select" id="satelliteSource">
                            <option value="sentinel2">Sentinel-2</option>
                            <option value="landsat8">Landsat-8</option>
                            <option value="landsat9">Landsat-9</option>
                        </select>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <label for="cloudCover" class="form-label">Max Cloud Cover (%)</label>
                            <input type="number" class="form-control" id="cloudCover" value="20" min="0" max="100">
                        </div>
                        <div class="col-md-6">
                            <label for="changeThreshold" class="form-label">Change Threshold</label>
                            <input type="number" class="form-control" id="changeThreshold" value="0.3" min="0" max="1" step="0.1">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create AOI</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Initialize map
var map = L.map('map').setView([39.8283, -98.5795], 4); // Center on USA

// Base layers
var osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '© OpenStreetMap contributors'
});

var satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
    attribution: '© Esri'
});

// Add default layer
satellite.addTo(map);

// Layer control
var baseLayers = {
    "Satellite": satellite,
    "OpenStreetMap": osm
};

L.control.layers(baseLayers).addTo(map);

// Drawing layers
var drawnItems = new L.FeatureGroup();
map.addLayer(drawnItems);

var drawControl = new L.Control.Draw({
    edit: {
        featureGroup: drawnItems
    },
    draw: {
        polygon: true,
        rectangle: true,
        circle: false,
        marker: false,
        circlemarker: false,
        polyline: false
    }
});

// Variables
var currentPolygon = null;
var isDrawingMode = false;

// Drawing controls
document.getElementById('drawPolygon').addEventListener('click', function() {
    enableDrawing();
});

document.getElementById('editPolygon').addEventListener('click', function() {
    enableEditing();
});

document.getElementById('deletePolygon').addEventListener('click', function() {
    deleteSelected();
});

document.getElementById('clearAll').addEventListener('click', function() {
    clearAll();
});

// Enable drawing mode
function enableDrawing() {
    if (currentPolygon) {
        alert('Please clear the current polygon before drawing a new one.');
        return;
    }
    
    isDrawingMode = true;
    map.once('draw:created', function(event) {
        var layer = event.layer;
        currentPolygon = layer;
        drawnItems.addLayer(layer);
        
        // Calculate area
        var area = turf.area(layer.toGeoJSON()) / 1000000; // Convert to km²
        updateAOIInfo('New AOI', area);
        
        isDrawingMode = false;
    });
    
    new L.Draw.Polygon(map, {}).enable();
}

// Enable editing mode
function enableEditing() {
    if (!currentPolygon) {
        alert('No polygon selected for editing.');
        return;
    }
    
    new L.EditToolbar.Edit(map, {
        featureGroup: L.featureGroup([currentPolygon])
    }).enable();
}

// Delete selected polygon
function deleteSelected() {
    if (currentPolygon) {
        drawnItems.removeLayer(currentPolygon);
        currentPolygon = null;
        hideAOIInfo();
    }
}

// Clear all polygons
function clearAll() {
    drawnItems.clearLayers();
    currentPolygon = null;
    hideAOIInfo();
}

// Update AOI info panel
function updateAOIInfo(name, area) {
    document.getElementById('aoiName').textContent = name;
    document.getElementById('aoiArea').textContent = area.toFixed(2);
    document.getElementById('aoiInfo').style.display = 'block';
}

// Hide AOI info panel
function hideAOIInfo() {
    document.getElementById('aoiInfo').style.display = 'none';
}

// Load existing AOIs
function loadAOIs() {
    fetch('{% url "core:aoi_geojson" %}')
        .then(response => response.json())
        .then(data => {
            displayAOIs(data);
            updateAOIList(data.features);
        })
        .catch(error => {
            console.error('Error loading AOIs:', error);
        });
}

// Display AOIs on map
function displayAOIs(geojson) {
    var aoiLayer = L.geoJSON(geojson, {
        style: function(feature) {
            return {
                color: feature.properties.is_active ? '#10b981' : '#f59e0b',
                weight: 2,
                fillOpacity: 0.1
            };
        },
        onEachFeature: function(feature, layer) {
            var popupContent = `
                <strong>${feature.properties.name}</strong><br>
                Area: ${feature.properties.area_km2.toFixed(2)} km²<br>
                Satellite: ${feature.properties.satellite_source}<br>
                Status: ${feature.properties.is_active ? 'Active' : 'Inactive'}
            `;
            layer.bindPopup(popupContent);
            
            layer.on('click', function() {
                currentPolygon = layer;
                updateAOIInfo(feature.properties.name, feature.properties.area_km2);
            });
        }
    });
    
    aoiLayer.addTo(map);
}

// Update AOI list in sidebar
function updateAOIList(aois) {
    var listContainer = document.getElementById('aoiList');
    
    if (aois.length === 0) {
        listContainer.innerHTML = `
            <div class="text-center text-muted py-4">
                <i class="fas fa-map-marker-alt fa-3x mb-3"></i>
                <p>No AOIs created yet.<br>Use the map to draw your first area of interest.</p>
            </div>
        `;
        return;
    }
    
    var listHTML = '';
    aois.forEach(function(aoi) {
        var statusClass = aoi.properties.is_active ? 'status-active' : 'status-inactive';
        var statusText = aoi.properties.is_active ? 'Active' : 'Inactive';
        
        listHTML += `
            <div class="border-bottom pb-3 mb-3">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h6 class="fw-bold mb-1">${aoi.properties.name}</h6>
                        <small class="text-muted">${aoi.properties.area_km2.toFixed(2)} km²</small>
                    </div>
                    <span class="status-badge ${statusClass}">${statusText}</span>
                </div>
                <p class="text-muted small mb-1">${aoi.properties.description || 'No description'}</p>
                <small class="text-muted">
                    <i class="fas fa-satellite me-1"></i>${aoi.properties.satellite_source}
                </small>
            </div>
        `;
    });
    
    listContainer.innerHTML = listHTML;
}

// AOI form submission
document.getElementById('aoiForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    if (!currentPolygon) {
        alert('Please draw a polygon on the map first.');
        return;
    }
    
    var formData = {
        name: document.getElementById('aoiNameInput').value,
        description: document.getElementById('aoiDescription').value,
        satellite_source: document.getElementById('satelliteSource').value,
        cloud_cover_threshold: document.getElementById('cloudCover').value,
        change_threshold: document.getElementById('changeThreshold').value,
        geometry: currentPolygon.toGeoJSON().geometry
    };
    
    // Submit to API
    fetch('/api/core/aois/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.id) {
            // Success
            var modal = bootstrap.Modal.getInstance(document.getElementById('aoiModal'));
            modal.hide();
            
            // Reset form
            document.getElementById('aoiForm').reset();
            
            // Reload AOIs
            loadAOIs();
            
            // Clear current polygon
            currentPolygon = null;
            clearAll();
            
            alert('AOI created successfully!');
        } else {
            alert('Error creating AOI: ' + JSON.stringify(data));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error creating AOI');
    });
});

// Layer toggles
document.getElementById('satelliteLayer').addEventListener('change', function() {
    if (this.checked) {
        satellite.addTo(map);
    } else {
        map.removeLayer(satellite);
    }
});

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    loadAOIs();
});
</script>

<!-- Include Turf.js for geometric calculations -->
<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

<!-- Include Leaflet Draw -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
{% endblock %} 